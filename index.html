<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ©ã‚¤ãƒ³ã‚¹ã‚­ãƒ£ãƒ³åˆ¤å®šï¼‹ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root { font-family: 'Inter', sans-serif; }
  #result-container { overflow-x: auto; white-space: nowrap; cursor: grab; }
  #capture-canvas { position: fixed; top: -9999px; left: -9999px; }
  #video { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; z-index:10; }
  .scan-line { position:absolute; top:0; height:100%; pointer-events:none; opacity:0.75; z-index:30; }
  .team-label { position:absolute; font-weight:bold; color:white; text-shadow:0 0 3px black; font-size:14px; }
</style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
<div class="max-w-4xl mx-auto">
<h1 class="text-3xl font-extrabold text-indigo-700 mb-6 text-center">ğŸ“¸ ãƒ©ã‚¤ãƒ³ã‚¹ã‚­ãƒ£ãƒ³åˆ¤å®šï¼‹ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ</h1>

<div id="message-box" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg mb-6 shadow-md">
<p class="font-bold">ğŸ ã‚¹ã‚­ãƒ£ãƒ³æº–å‚™</p>
<p class="text-sm">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã€ã‚¹ãƒªãƒƒãƒˆå¹…ãƒ»ãƒ©ã‚¤ãƒ³ä½ç½®ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
</div>

<div id="video-wrapper" class="relative w-full aspect-video bg-gray-800 rounded-xl overflow-hidden shadow-2xl mb-6 flex justify-center items-center">
  <video id="video" playsinline autoplay muted class="hidden"></video>
  <p id="video-placeholder" class="text-white text-center z-20">ã‚«ãƒ¡ãƒ©æ˜ åƒã®æº–å‚™ä¸­...</p>
  <div id="scan-line" class="scan-line bg-red-500" style="left:50%; width:2px;"></div>
</div>

<div class="bg-white p-5 rounded-xl shadow-lg mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
  <div class="flex flex-col w-full md:w-1/3">
    <label for="camera-select" class="text-gray-700 text-sm font-semibold mb-1">ã‚«ãƒ¡ãƒ©é¸æŠ:</label>
    <select id="camera-select" class="p-2 border border-gray-300 rounded-lg shadow-sm bg-white text-gray-800 w-full" disabled>
      <option value="">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹ã¨é¸æŠã§ãã¾ã™</option>
    </select>
  </div>
  <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto md:ml-4">
    <button id="setup-camera-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md">ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
    <button id="start-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md" disabled>â–¶ï¸ ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
    <button id="stop-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hidden">â¹ï¸ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
  </div>
</div>

<div class="bg-white p-5 rounded-xl shadow-lg mb-6 flex flex-col md:flex-row gap-4 items-center">
  <div class="flex items-center space-x-4">
    <label for="scan-offset" class="text-gray-700 text-sm font-semibold whitespace-nowrap">åˆ¤å®šãƒ©ã‚¤ãƒ³ä½ç½®:</label>
    <input type="range" id="scan-offset" min="-150" max="150" value="0" step="1" class="w-48 h-2 bg-gray-200 rounded-lg cursor-pointer">
    <span id="offset-value" class="text-indigo-600 font-bold w-10 text-right">0</span>
  </div>
  <div class="flex items-center space-x-4">
    <label for="slit-width" class="text-gray-700 text-sm font-semibold">ã‚¹ãƒªãƒƒãƒˆå¹…:</label>
    <input type="range" id="slit-width" min="1" max="10" value="2" step="1" class="w-32 h-2 bg-gray-200 rounded-lg cursor-pointer">
    <span id="slit-value" class="text-indigo-600 font-bold w-6 text-right">2</span>
  </div>
</div>

<div class="bg-white p-5 rounded-xl shadow-lg mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
  <div class="flex items-center space-x-4">
    <button id="sw-start" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">â±ï¸ SWã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <button id="sw-stop" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">â¹ï¸ SWã‚¹ãƒˆãƒƒãƒ—</button>
    <button id="sw-reset" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">ğŸ”„ SWãƒªã‚»ãƒƒãƒˆ</button>
    <span class="ml-4 text-indigo-700 font-bold" id="sw-display">0.00 s</span>
  </div>
</div>

<h2 class="text-xl font-semibold text-gray-800 mb-3">åˆ¤å®šçµæœ (ãƒ©ã‚¤ãƒ³ã‚¹ã‚­ãƒ£ãƒ³ç”»åƒ)</h2>
<div id="result-container" class="w-full h-80 bg-gray-900 rounded-xl shadow-inner border border-gray-300 overflow-x-scroll relative">
  <canvas id="result-canvas" class="h-full"></canvas>
</div>
<p class="text-sm text-gray-600 mt-2">å·¦å³ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ç€é †ãƒ»ã‚¿ã‚¤ãƒ ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚<br>ã‚¯ãƒªãƒƒã‚¯ã§ç¸¦ç·šè¿½åŠ ã€ãƒ‰ãƒ©ãƒƒã‚°ï¼†ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ç§»å‹•å¯èƒ½</p>

<div class="mt-6 text-center">
  <button id="download-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hidden">â¬‡ï¸ åˆ¤å®šç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
</div>

<canvas id="capture-canvas"></canvas>

<script>
const video = document.getElementById('video');
const videoPlaceholder = document.getElementById('video-placeholder');
const captureCanvas = document.getElementById('capture-canvas');
const captureCtx = captureCanvas.getContext('2d');
const resultCanvas = document.getElementById('result-canvas');
const resultCtx = resultCanvas.getContext('2d');
const setupCameraButton = document.getElementById('setup-camera-button');
const startButton = document.getElementById('start-button');
const stopButton = document.getElementById('stop-button');
const downloadButton = document.getElementById('download-button');
const messageBox = document.getElementById('message-box');
const scanLine = document.getElementById('scan-line');
const scanOffsetInput = document.getElementById('scan-offset');
const offsetValueSpan = document.getElementById('offset-value');
const slitInput = document.getElementById('slit-width');
const slitValueSpan = document.getElementById('slit-value');
const resultContainer = document.getElementById('result-container');
const cameraSelect = document.getElementById('camera-select');

// ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ
const swDisplay = document.getElementById('sw-display');
let stopwatchTime = 0, swInterval=null;
function updateSW(){ swDisplay.textContent = stopwatchTime.toFixed(2)+' s'; }
function startStopwatch(){ if(!swInterval) swInterval=setInterval(()=>{stopwatchTime+=0.0167; updateSW();},16.7);}
function stopStopwatch(){ if(swInterval){clearInterval(swInterval); swInterval=null;}}
function resetStopwatch(){stopwatchTime=0; updateSW();}

// ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒãƒœã‚¿ãƒ³
document.getElementById('sw-start').onclick=startStopwatch;
document.getElementById('sw-stop').onclick=stopStopwatch;
document.getElementById('sw-reset').onclick=()=>{resetStopwatch(); timeLog=[];};

// ãƒ©ã‚¤ãƒ³ã‚¹ã‚­ãƒ£ãƒ³è¨­å®š
let stream=null, scanning=false, scanX=0, animationFrameId=null;
const FRAME_HEIGHT=320;
let timeLog=[];

// ç¸¦ç·šç®¡ç†
let lines=[], lineColors=['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff'];

// ã‚¹ãƒªãƒƒãƒˆä½ç½®ã¨å¹…
scanOffsetInput.addEventListener('input', e=>{
  const val=parseInt(e.target.value); offsetValueSpan.textContent=val; scanLine.style.left=`calc(50% + ${val}px)`;
});
slitInput.addEventListener('input', e=>{
  const val=parseInt(e.target.value); slitValueSpan.textContent=val;
});

// ã‚«ãƒ¡ãƒ©ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
setupCameraButton.addEventListener('click',()=>{setupCamera();});
async function updateDeviceList(selectedId=null){
  const devices=await navigator.mediaDevices.enumerateDevices();
  const videoDevices=devices.filter(d=>d.kind==='videoinput');
  cameraSelect.innerHTML='';
  if(videoDevices.length===0){cameraSelect.disabled=true; cameraSelect.innerHTML='<option>ã‚«ãƒ¡ãƒ©ãªã—</option>'; return;}
  videoDevices.forEach(d=>{ const opt=document.createElement('option'); opt.value=d.deviceId; opt.text=d.label||'ã‚«ãƒ¡ãƒ© '+(videoDevices.indexOf(d)+1); cameraSelect.appendChild(opt); });
  cameraSelect.disabled=false;
  cameraSelect.value=selectedId||videoDevices[0].deviceId;
}
cameraSelect.addEventListener('change', ()=>{if(scanning) stopScanning(); setupCamera(cameraSelect.value);});

async function setupCamera(deviceId=null){
  if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;}
  setupCameraButton.disabled=true; startButton.disabled=true; cameraSelect.disabled=true;
  messageBox.className='bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-lg mb-6 shadow-md';
  messageBox.innerHTML='<p class="font-bold">ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...</p>';
  let constraints={video:{frameRate:{ideal:60}}, audio:false};
  if(deviceId) constraints.video.deviceId={exact:deviceId}; else constraints.video.facingMode='environment';
  try{
    stream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=stream; await video.play(); video.classList.remove('hidden'); videoPlaceholder.classList.add('hidden');
    await updateDeviceList(stream.getVideoTracks()[0].getSettings().deviceId);
    startButton.disabled=false; cameraSelect.disabled=false;
    messageBox.className='bg-green-100 border-l-4 border-green-500 text-green-800 p-4 rounded-lg mb-6 shadow-md';
    messageBox.innerHTML='<p class="font-bold">âœ… ã‚«ãƒ¡ãƒ©æº–å‚™å®Œäº†</p>';
  }catch(err){console.error(err);
    messageBox.className='bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg mb-6 shadow-md';
    messageBox.innerHTML='<p class="font-bold">âŒ ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—</p><p>'+err.message+'</p>'; setupCameraButton.disabled=false;
  }
}

// --- ãƒ©ã‚¤ãƒ³ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† ---
function processFrame(){
  if(!scanning||video.paused||video.ended) return;
  captureCanvas.width=video.videoWidth; captureCanvas.height=video.videoHeight;
  captureCtx.drawImage(video,0,0,captureCanvas.width,captureCanvas.height);

  const offset = parseInt(scanOffsetInput.value);
  const slit = parseInt(slitInput.value);
  const x = Math.floor(captureCanvas.width/2)+offset;

  const resultWidth=resultCanvas.width;
  let existingData=null;
  if(resultWidth>0){try{existingData=resultCtx.getImageData(0,0,resultWidth,FRAME_HEIGHT);}catch(e){console.warn(e);}}
  resultCanvas.width=resultWidth+slit; resultCanvas.height=FRAME_HEIGHT;
  if(existingData) resultCtx.putImageData(existingData,0,0);

  const imageData=captureCtx.getImageData(x,0,slit,captureCanvas.height);
  const tempCanvas=document.createElement('canvas'); const tempCtx=tempCanvas.getContext('2d');
  tempCanvas.width=slit; tempCanvas.height=captureCanvas.height; tempCtx.putImageData(imageData,0,0);

  // è‰²åˆ¤å®š
  const pixels=imageData.data;
  let sumR=0,sumG=0,sumB=0;
  for(let i=0;i<pixels.length;i+=4){sumR+=pixels[i]; sumG+=pixels[i+1]; sumB+=pixels[i+2];}
  const avgR=sumR/(pixels.length/4), avgG=sumG/(pixels.length/4), avgB=sumB/(pixels.length/4);
  let color='white'; if(avgR>150 && avgR>avgG && avgR>avgB) color='red';

  // æç”»
  resultCtx.drawImage(tempCanvas,resultWidth,0,slit,FRAME_HEIGHT);
  if(color!=='white'){
    resultCtx.fillStyle=color==='red'?'rgba(255,0,0,0.7)':'rgba(255,255,255,0.7)';
    resultCtx.fillRect(resultWidth,0,slit,FRAME_HEIGHT);
    resultCtx.fillStyle='yellow';
    resultCtx.font='bold 14px sans-serif';
    resultCtx.fillText(scanX+1,resultWidth+2,20);
  }

  // ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã®ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒæ™‚é–“è¨˜éŒ²
  timeLog.push(stopwatchTime);

  // ç¸¦ç·šæç”»
  lines.forEach((l,i)=>{
    resultCtx.strokeStyle = l.color;
    resultCtx.lineWidth = 2;
    resultCtx.beginPath(); resultCtx.moveTo(l.x,0); resultCtx.lineTo(l.x,FRAME_HEIGHT); resultCtx.stroke();
    const frameIndex=Math.floor(l.x);
    const lineTime=timeLog[frameIndex] || stopwatchTime;
    resultCtx.fillStyle=l.color;
    resultCtx.font='bold 14px sans-serif';
    resultCtx.fillText(lineTime.toFixed(2),l.x+2,30);
  });

  scanX+=1;
  resultContainer.scrollLeft=resultContainer.scrollWidth;
  if(scanning) animationFrameId=requestAnimationFrame(processFrame);
}

// --- ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ãƒ»åœæ­¢ ---
startButton.addEventListener('click',()=>{
  if(!stream||startButton.disabled){messageBox.className='bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg mb-6 shadow-md'; messageBox.innerHTML='<p>å…ˆã«ã‚«ãƒ¡ãƒ©èµ·å‹•ã—ã¦ãã ã•ã„</p>'; return;}
  scanning=true; scanX=0; startButton.classList.add('hidden'); stopButton.classList.remove('hidden'); downloadButton.classList.add('hidden'); cameraSelect.disabled=true;
  resultCanvas.width=1; resultCtx.clearRect(0,0,resultCanvas.width,resultCanvas.height); timeLog=[];
  animationFrameId=requestAnimationFrame(processFrame);
  messageBox.className='bg-indigo-100 border-l-4 border-indigo-500 text-indigo-800 p-4 rounded-lg mb-6 shadow-md';
  messageBox.innerHTML='<p class="font-bold">ğŸŸ¢ ã‚¹ã‚­ãƒ£ãƒ³ä¸­...</p>';
});

stopButton.addEventListener('click',()=>{
  scanning=false; cancelAnimationFrame(animationFrameId);
  startButton.classList.remove('hidden'); stopButton.classList.add('hidden'); downloadButton.classList.remove('hidden'); cameraSelect.disabled=false;
  stopStopwatch();
  messageBox.className='bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg mb-6 shadow-md';
  messageBox.innerHTML='<p class="font-bold">â¸ï¸ ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</p>';
});

// --- åˆ¤å®šç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ---
downloadButton.addEventListener('click',()=>{
  const a=document.createElement('a');
  a.href=resultCanvas.toDataURL('image/png');
  a.download=`LineScan_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
});

// --- çµæœã‚­ãƒ£ãƒ³ãƒã‚¹ãƒ‰ãƒ©ãƒƒã‚° ---
let isDown=false, startX, scrollLeft;
resultContainer.addEventListener('mousedown',e=>{isDown=true; resultContainer.style.cursor='grabbing'; startX=e.pageX-resultContainer.offsetLeft; scrollLeft=resultContainer.scrollLeft;});
resultContainer.addEventListener('mouseleave',()=>{isDown=false; resultContainer.style.cursor='grab';});
resultContainer.addEventListener('mouseup',()=>{isDown=false; resultContainer.style.cursor='grab';});
resultContainer.addEventListener('mousemove',e=>{if(!isDown) return; e.preventDefault(); const x=e.pageX-resultContainer.offsetLeft; resultContainer.scrollLeft=scrollLeft-(x-startX)*1.5;});
resultContainer.addEventListener('touchstart',e=>{isDown=true; startX=e.touches[0].pageX-resultContainer.offsetLeft; scrollLeft=resultContainer.scrollLeft;});
resultContainer.addEventListener('touchend',()=>{isDown=false;});
resultContainer.addEventListener('touchmove',e=>{if(!isDown) return; const x=e.touches[0].pageX-resultContainer.offsetLeft; resultContainer.scrollLeft=scrollLeft-(x-startX)*1.5;});

// --- ç¸¦ç·šè¿½åŠ ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰ ---
resultCanvas.addEventListener('click', e=>{
  const rect=resultCanvas.getBoundingClientRect();
  const x=e.clientX-rect.left+resultContainer.scrollLeft;
  const color=lineColors[lines.length%lineColors.length];
  lines.push({x:x,color:color});
});

</script>
</body>
</html>
